#! /usr/bin/env bash

set -euo pipefail

set -x 

fqdn="xn--rdetdags-zza.nu"
# Copy required configuration files.
scp compose.yml dax@$fqdn: > /dev/null

# Decrypt and copy secrets.
age --decrypt --identity "$AGE_IDENTITY" secrets.env.age | ssh dax@$fqdn "cat > ~/.env"

# Log in to container registry, pull image and restart services.
age --decrypt --identity "$AGE_IDENTITY" ghcr-password.age | ssh dax@$fqdn "docker login --username Majsvaffla --password-stdin ghcr.io 2> /dev/null"
ssh dax@$fqdn "docker pull ghcr.io/majsvaffla/dax:latest --quiet" > /dev/null
ssh dax@$fqdn "docker compose up --detach"

set +x
echo Running health checks...

curl="curl -sS \
    --retry 10 \
    --retry-all-errors \
    --retry-connrefused \
    --retry-delay 1 \
    --retry-max-time 5
"

function alive_or_exit {
    # shellcheck disable=SC2068
    if [[ $($@) != "Tackar som frÃ¥gar!"* ]]; then
        >&2 echo "Health check failed :("
        exit 1
    fi
}

# Perform health checks.
alive_or_exit ssh dax@$fqdn "dotenv $curl http://localhost:8000/-/"
alive_or_exit "$curl https://$fqdn/-/"

echo Deployment successful!
